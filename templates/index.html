<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dailymotion Video Downloader</title>
</head>
<body>
    <h2>Dailymotion Video Downloader</h2>
    <p id="status">Waiting for video URL...</p>

    <script>
    async function getDownloadLink(url) {
        document.getElementById("status").textContent = "Fetching download link...";

        try {
            const response = await fetch("/get_dailymotion_link", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();

            if (data.download_url) {
                document.getElementById("status").textContent = "Downloading...";
                if (data.download_url.endsWith(".m3u8")) {
                    await downloadM3U8(data.download_url);
                } else {
                    await progressiveDownload(data.download_url, "video.mp4");
                }
            } else {
                document.getElementById("status").textContent = "Error: " + data.error;
            }
        } catch (error) {
            document.getElementById("status").textContent = "An error occurred.";
            console.error(error);
        }
    }

    async function progressiveDownload(fileUrl, fileName) {
        const response = await fetch(fileUrl);
        if (!response.ok) {
            document.getElementById("status").textContent = "Failed to download.";
            return;
        }

        const fileHandle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: [{ description: "Video Files", accept: { "video/mp4": [".mp4"] } }]
        });

        const writableStream = await fileHandle.createWritable();
        const reader = response.body.getReader();

        let receivedLength = 0;
        const totalLength = response.headers.get("Content-Length") || 0;

        async function processStream() {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                receivedLength += value.length;
                await writableStream.write(value);
                document.getElementById("status").textContent = `Downloading... ${Math.round((receivedLength / totalLength) * 100)}%`;
            }

            await writableStream.close();
            document.getElementById("status").textContent = "Download complete!";
        }

        await processStream();
    }

    function getQueryParameter(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    window.onload = () => {
        const videoUrl = getQueryParameter("url");
        if (videoUrl) {
            getDownloadLink(videoUrl);
        } else {
            document.getElementById("status").textContent = "No video URL provided.";
        }
    };
    </script>
</body>
</html>
